#!/usr/bin/env bash

REPO_DIR="$HOME/nix-hosts"
MSG="${1:-$(date -u +'%Y-%m-%d %H:%M UTC')}"

cd "$REPO_DIR" || exit 1

if [ -d "$REPO_DIR/home/tilde" ]; then
    echo
    echo ":: Stowing $REPO_DIR/home/tilde..."
    echo

    mkdir -p "$HOME/.config"
    mkdir -p "$HOME/.local/bin"
    mkdir -p "$HOME/.local/share/applications"

    stow --adopt -d "$REPO_DIR/home" -t "$HOME" tilde --verbose=1
fi

echo
echo ":: Syncing NixOS Configuration..."
echo

git add .
git commit -m "$MSG"
git push
    
if command -v repomix &> /dev/null; then
    repomix
fi
